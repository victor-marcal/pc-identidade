# pc-identidade

## üìÑ Objetivo do Projeto

Desenvolvi essa aplica√ß√£o durante o Projeto Carreira Desenvolvedor Back-End Junior do LuizaLabs. 

O objetivo do projeto era cada grupo desenvolver um m√≥dulo de um Marketplace e meu grupo ficou respons√°vel pela Identidade do varejista.

A aplica√ß√£o foi desenvolvida utilizando Python com FastAPI, al√©m de utilizar diversas tecnologias, como Docker, Redis, RabbitMQ, MongoDB e Keycloak.


## üìå Identidade do Varejista e Gerenciamento de Acesso

O projeto **pc-identidade** √© o pilar central para a gest√£o do ciclo de vida de **Varejistas (Sellers)** e de seus respectivos **Usu√°rios** no ecossistema do marketplace. Ele n√£o apenas garante a integridade dos dados cadastrais, mas tamb√©m prov√™ uma camada de seguran√ßa robusta para controle de acesso, atuando como a fonte da verdade sobre quem s√£o os participantes da plataforma e o que eles podem fazer.

As responsabilidades do servi√ßo foram expandidas para incluir:

* **API Completa para Sellers:** Oferece endpoints RESTful para o ciclo de vida completo de um seller (CRUD), incluindo valida√ß√µes de dados, regras de neg√≥cio e um sistema de exclus√£o l√≥gica ("soft delete") atrav√©s de um campo de `status`.
* **Integra√ß√£o com Keycloak:** Automatiza a cria√ß√£o e gerenciamento de usu√°rios no Keycloak. Cada novo seller ou usu√°rio criado na plataforma tem sua identidade correspondente gerenciada pelo servi√ßo.
* **Autentica√ß√£o e Autoriza√ß√£o:** Protege os endpoints da API utilizando tokens JWT. A valida√ß√£o dos tokens √© otimizada com um sistema de cache em **Redis** para garantir alta performance.
* **Controle de Acesso Granular:** Implementa permiss√µes detalhadas. Um usu√°rio comum s√≥ pode visualizar e modificar os dados dos sellers aos quais est√° explicitamente associado (atrav√©s do atributo `sellers` no Keycloak).
* **Fluxos de Seguran√ßa:** Notifica outros sistemas sobre eventos importantes (como a cria√ß√£o de um seller) de forma ass√≠ncrona via **RabbitMQ**.
* **Gerenciamento de Dados:** Inclui uma estrat√©gia de "Cold Storage", com um banco de dados secund√°rio para arquivar sellers inativos, mantendo a base de dados principal enxuta e perform√°tica.
* **Observabilidade:** Utiliza um sistema de logging estruturado para registrar o fluxo de requisi√ß√µes, opera√ß√µes de neg√≥cio e erros, facilitando a depura√ß√£o e o monitoramento.

[Documenta√ß√£o completa do Projeto](https://docs.google.com/document/d/18UmqZwHXrsCcxbGn8raetuuCkwxFn-MVRGkGLvDxTzA/edit?usp=sharing)

## üéØ Objetivos principais:
- Identifica√ß√£o e valida√ß√£o da identidade do varejista
- Recolhimento e an√°lise de dados/documentos obrigat√≥rios
- Organiza√ß√£o das informa√ß√µes operacionais e de neg√≥cio
- Prepara√ß√£o dos dados para uso nas demais √°reas do marketplace

## üë• Participantes do Time:

- Jo√£o Pedro
- Marcella Palazzo
- Murilo Alves
- Victor Hugo Buiatti

---

## üê≥ Instala√ß√£o do Docker

Para instala√ß√£o do [Docker](https://www.docker.com/products/docker-desktop/), siga o manual dispon√≠vel no site oficial.

## üöÄ Ambiente de Desenvolvimento Local (Windows)

Este guia descreve o fluxo de trabalho para rodar os servi√ßos de apoio (MongoDB, Keycloak, etc.) via Docker, e a aplica√ß√£o FastAPI localmente na sua m√°quina.

### Pr√©-requisitos
- **Git**
- **Python 3.12**
- **Docker Desktop** para Windows (instalado e em execu√ß√£o)

### Passo 1: Preparar o Projeto

1.  **Clone o Reposit√≥rio:** Se ainda n√£o o fez, clone o projeto.
    ```powershell
    git clone [https://github.com/projeto-carreira-luizalabs-2025/pc-identidade.git](https://github.com/projeto-carreira-luizalabs-2025/pc-identidade.git)
    ```

2.  **Acesse a Pasta do Projeto:**
    ```powershell
    cd pc-identidade
    ```

### Passo 2: Configurar Vari√°veis de Ambiente (`.env`)

Crie um arquivo chamado `.env` na raiz do projeto. Ele √© crucial para a comunica√ß√£o da sua aplica√ß√£o com os servi√ßos no Docker.

**Solicite as informa√ß√µes confidenciais com o time e copie o conteudo no seu .env:**
```env
# Vari√°veis de Ambiente
ENV=dev

# MongoDB
APP_DB_URL_MONGO=mongodb://admin:admin@localhost:27017/pc_identidade?authSource=admin&connectTimeoutMS=1000&socketTimeoutMS=1000
MONGO_DB=pc_identidade

# Keycloak
KEYCLOAK_URL=http://localhost:8080
KEYCLOAK_REALM_NAME=marketplace
KEYCLOAK_CLIENT_ID=varejo
KEYCLOAK_WELL_KNOWN_URL=http://localhost:8080/realms/marketplace/.well-known/openid-configuration

# Credenciais Admin do Keycloak (usadas pelo KeycloakAdminClient)
KEYCLOAK_ADMIN_USER=admin_marketplace
KEYCLOAK_ADMIN_PASSWORD=senha123
KEYCLOAK_ADMIN_CLIENT_ID=admin-cli

# Configura√ß√µes do RabbitMQ
RABBITMQ_HOST=localhost
RABBITMQ_PORT=5672
RABBITMQ_USERNAME=admin
RABBITMQ_PASSWORD=admin
RABBITMQ_EXCHANGE=data_exchange
RABBITMQ_QUEUE=data_queue
RABBITMQ_ROUTING_KEY=

# Configura√ß√µes do Email
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
SENDER_EMAIL=joaopedrovr91@gmail.com
SENDER_PASSWORD=[SOLICITAR COM O TIME]

# Configura√ß√µes de Logging
PC_LOGGING_LEVEL=info
PC_LOGGING_ENV=dev

# --- Configura√ß√µes do Banco de Dados Frio ---
MONGO_COLD_URL=mongodb://admin_cold:admin_cold@localhost:27018/identidade_db?authSource=admin&connectTimeoutMS=1000&socketTimeoutMS=1000

# Configura√ß√£o do Gemini
API_KEY_GEMINI=[SOLICITAR COM O TIME]

# Configura√ß√£o Webhook 
WEBHOOK_URL=[SOLICITAR COM O TIME]

# --- Configura√ß√£o do Redis ---
REDIS_URL=redis://localhost:6379/0
```

### Passo 3: Preparar Ambiente Python

1. **Crie o ambiente virtual (execute apenas uma vez):**

```powershell
python -m venv venv
```

2. **Ative o ambiente virtual (execute sempre que for desenvolver):**

```powershell
.\venv\Scripts\activate
```

3. **Instale as depend√™ncias:**

```powershell
pip install -r requirements.txt
```

### Passo 4: Iniciar os Servi√ßos no Docker

Este comando ir√° subir os cont√™ineres do MongoDB (quente e frio), Keycloak e RabbitMQ.

```powershell
docker-compose up --build -d
```

Aguarde de 1 a 2 minutos para que os servi√ßos iniciem completamente.

### Passo 5: Configurar o Keycloak (Passo Cr√≠tico P√≥s-Inicializa√ß√£o)

Ap√≥s os cont√™ineres estarem no ar, voc√™ precisa executar o script abaixo para configurar corretamente os atributos de usu√°rio no Keycloak.

```powershell
# Com o venv ativado
python devtools/keycloak-config/setup_sellers_attribute.py
```

### Passo 6: Executar a Aplica√ß√£o FastAPI

Com tudo pronto, inicie o servidor da sua aplica√ß√£o localmente (garanta que o venv est√° ativado).

```powershell
uvicorn app.api_main:app --reload --port 8000
```

### Acessando os Servi√ßos

- API (Swagger UI): http://127.0.0.1:8000/api/docs
- Admin Console do Keycloak: http://localhost:8080
  - **Usu√°rio**: admin
  - **Senha**: admin
- RabbitMQ Management: http://localhost:15672

---

## üõ†Ô∏è Tarefas de Manuten√ß√£o e Scripts

Execute estes scripts no seu terminal com o ambiente virtual (venv) ativado.

### Arquivando Sellers Inativos (Banco Frio)

Para mover todos os sellers com status "Inativo" do banco de dados principal para o banco de dados de arquivamento (frio), execute:

```powershell
python devtools/scripts/move_inactive_to_cold.py
```

## üîç An√°lise de Qualidade com SonarQube

Para subir o ambiente do SonarQube com Docker Compose, execute:

``` bash
make docker-compose-sonar-up # Inicia o servidor SonarQube e seus servi√ßos dependentes (como o banco de dados) via Docker Compose
```

Ap√≥s a execu√ß√£o, acesse a interface web do SonarQube em: http://localhost:9000

Se em algum momento quiser parar o ambiente do SonarQube, execute:

```bash
make docker-compose-sonar-down # Desligar√° o ambiente do SonarQube e remover√° os cont√™ineres
```

### 1. Gere e exporte o token do SonarQube
Ap√≥s acessar o SonarQube:

* **V√° em "My Account" > "Security".**

* **Gere um novo token (ex: pc-identidade-token).**

* **No terminal, exporte o token:**

```
export SONAR_TOKEN=<seu_token_aqui>
export SONAR_HOST_URL=http://localhost:9000 pysonar-scanner
```

### Windows üñ•Ô∏è

1. Baixar o Sonar Scanner

üîó Link oficial

Acesse: https://docs.sonarsource.com/sonarqube/latest/analyzing-source-code/scanners/sonarscanner/

Clique em Download the SonarScanner.

Baixe o arquivo .zip para Windows (ex: sonar-scanner-cli-5.x.x-windows.zip).

Extraia para um local como: C:\sonar-scanner\

2. Configurar Vari√°veis de Ambiente ‚úÖ 

üîß Adicionar ao PATH:

Abra o menu Iniciar e digite "vari√°veis de ambiente".

Clique em "Editar vari√°veis de ambiente do sistema".

Em Vari√°veis de Sistema, clique em Path > Editar > Novo e adicione:

```
C:\sonar-scanner\bin
```
Clique em OK para fechar tudo.

para rodar no projeto e apenas digitar no terminal 
```
sonar-scanner 
```

Isso ir√° enviar os dados da sua aplica√ß√£o para an√°lise no SonarQube.


No windows √© necess√°rio configurar o token e host_url:
```
$env:SONAR_HOST_URL = "http://localhost:9000"
$env:SONAR_TOKEN = "seu-token"
```

3. Execute o Sonar Scanner

Com os containers rodando e o token configurado, execute:

```
SONAR_HOST_URL=http://localhost:9000 pysonar-scanner
```

## üìÑ Sistema de Migrations para MongoDB

O projeto utiliza um sistema de migrations para gerenciar mudan√ßas no esquema do banco de dados MongoDB de forma organizada e versionada.

### üöÄ Como criar uma nova migration

Voc√™ pode criar uma nova migration de duas formas:

**Op√ß√£o 1 - Usando o comando original da biblioteca:**
```bash
mongodb-migrate-create --description "adicionar campo status na collection users"
```

**Op√ß√£o 2 - Usando o comando do Makefile (recomendado):**
```bash
make migration-create NOME="adicionar campo status na collection users"
```

Ambos os comandos criar√£o um arquivo de migration na pasta `migrations/` com timestamp e descri√ß√£o.

### ‚ñ∂Ô∏è Como executar as migrations

Para aplicar todas as migrations pendentes, voc√™ pode usar:

**Op√ß√£o 1 - Usando o comando do Makefile (recomendado):**
```bash
make migration-run
```

**Op√ß√£o 2 - Executando diretamente o script:**
```bash
python3.12 run_migrations.py
```

### üîß Configura√ß√£o

As migrations utilizam a mesma configura√ß√£o de banco definida nas vari√°veis de ambiente do projeto (`APP_DB_URL_MONGO`).


### Comandos √öteis do Dia a Dia

Para parar todos os servi√ßos:

```bash
docker-compose down
```

Para iniciar os servi√ßos novamente (sem reconstruir):

```bash
docker-compose up -d
```

Para testar se o Mongo est√° acess√≠vel

Em outro terminal, rode:

```bash
docker run --rm -it mongo mongosh "mongodb://admin:admin@pc-identidade-mongo:27017/bd01?authSource=admin"
```

Voc√™ ver√° o prompt bd01> se tudo estiver OK.
